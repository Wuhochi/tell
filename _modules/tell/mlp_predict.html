<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tell.mlp_predict &mdash; TELL latest documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/panels-bootstrap.5fd3999ee7762ccc51105388f4a9d115.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/style.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> TELL
          </a>
              <div class="version">
                0.0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../README.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tell_quickstarter.html">Quickstarter Notebook</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../user_guide.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../acknowledgement.html">Acknowledgement</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">TELL</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>tell.mlp_predict</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tell.mlp_predict</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">holidays</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.dates</span> <span class="k">as</span> <span class="nn">mdates</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">pearsonr</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LinearRegression</span> <span class="k">as</span> <span class="n">LR</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">r2_score</span><span class="p">,</span> <span class="n">mean_squared_error</span><span class="p">,</span> <span class="n">mean_absolute_percentage_error</span>
<span class="kn">from</span> <span class="nn">sklearn.neural_network</span> <span class="kn">import</span> <span class="n">MLPRegressor</span> <span class="k">as</span> <span class="n">MLP</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">GridSearchCV</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="ne">UserWarning</span><span class="p">)</span>

<span class="c1"># define month_list for plots</span>
<span class="n">MONTH_LIST</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;Jan&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Feb&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Mar&quot;</span><span class="p">,</span>
    <span class="s2">&quot;April&quot;</span><span class="p">,</span>
    <span class="s2">&quot;May&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Jun&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Jul&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Aug&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Sep&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Oct&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Nov&quot;</span><span class="p">,</span>
    <span class="s2">&quot;Dec&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="c1"># set random seed, change this value as you prefer</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">391</span><span class="p">)</span>


<div class="viewcode-block" id="Dataset"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Dataset">[docs]</a><span class="k">class</span> <span class="nc">Dataset</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    class for preprocessing the dataset for all BAs</span>

<span class="sd">    :param region: str indicating region/BA we want to train and test on. must match with str in csv</span>
<span class="sd">    :param csv_dir: str dir where the csvs are located</span>
<span class="sd">    :param start_time: str start time in YYYY-MM-DD. all data before this time as not considered</span>
<span class="sd">    :param end_time: str end_time in YYYY-MM-DD. all data after this time is not considered</span>
<span class="sd">    :param split_time: partition time in YYYY-MM-DD to split into training and test_set</span>
<span class="sd">    :param x_var: list-&gt; features to consider</span>
<span class="sd">    :param y_var: list-&gt; targets to consider</span>
<span class="sd">    :param add_dayofweek: bool -&gt; weather we want to consider weekday vs weekend informoation</span>
<span class="sd">    :param linear_mode_bool: bool-&gt; whether it is a linear model or not. if so, the month and hour will need to be sinusoidal</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
             <span class="bp">self</span><span class="p">,</span>
             <span class="n">region</span> <span class="o">=</span> <span class="s1">&#39;PJM&#39;</span><span class="p">,</span>
             <span class="n">csv_dir</span> <span class="o">=</span> <span class="s2">&quot;..</span><span class="se">\\</span><span class="s2">CSV_Files&quot;</span><span class="p">,</span>
             <span class="n">start_time</span><span class="o">=</span><span class="s2">&quot;2016-01-01 00:00:00&quot;</span><span class="p">,</span>
             <span class="n">end_time</span><span class="o">=</span><span class="s2">&quot;2019-12-31 23:00:00&quot;</span><span class="p">,</span>
             <span class="n">split_time</span><span class="o">=</span><span class="s2">&quot;2018-12-31 23:00:00&quot;</span><span class="p">,</span>
             <span class="n">x_var</span><span class="o">=</span><span class="p">[</span>
                 <span class="s2">&quot;Hour&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;Month&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;Temperature&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;Specific_Humidity&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;Wind_Speed&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;Longwave_Radiation&quot;</span><span class="p">,</span>
                 <span class="s2">&quot;Shortwave_Radiation&quot;</span>
             <span class="p">],</span>
             <span class="c1"># &#39;Longwave_Radiation&#39;, &#39;Wind_Speed&#39;</span>
             <span class="n">y_var</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Demand&quot;</span><span class="p">],</span>
             <span class="n">add_dayofweek</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">linear_mode_bool</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
     <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">csv_dir</span> <span class="o">=</span> <span class="n">csv_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">start_time</span><span class="p">,</span> <span class="n">end_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_time</span> <span class="o">=</span> <span class="n">split_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_var</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_var</span> <span class="o">=</span> <span class="n">x_var</span><span class="p">,</span> <span class="n">y_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_model_bool</span> <span class="o">=</span> <span class="n">linear_mode_bool</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">add_dayofweek</span> <span class="o">=</span> <span class="n">add_dayofweek</span>

        <span class="c1"># Get x_var and y_var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_eval</span><span class="p">,</span> <span class="n">day_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">read_data</span><span class="p">()</span>

        <span class="c1"># get training and test data</span>
        <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_t</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_e</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_eval</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_t</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_e</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">X_eval</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Y_t</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Y_e</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Y_eval</span>
        <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_data</span><span class="p">(</span><span class="n">day_list</span><span class="o">=</span><span class="n">day_list</span><span class="p">)</span>

<div class="viewcode-block" id="Dataset.read_data"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Dataset.read_data">[docs]</a>    <span class="k">def</span> <span class="nf">read_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to read csvs</span>
<span class="sd">        :return df (pd.DataFrame) - entire data contained within start_time and end_time</span>
<span class="sd">        :return df_t (pd.DataFrame) - training data (before split_time)</span>
<span class="sd">        :return df_e (pd.DataFrame) - evaluation data (after split_time)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># step 1-&gt; check filename</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_filename</span><span class="p">()</span>
        <span class="c1"># step 2-&gt; read csv</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="c1"># Step 2B - Rename the columns</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rename_columns</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="c1"># step 3-&gt; sort df by timeframe specified in start_time and end_time</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sort_timeframe</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="c1"># step 4 -&gt; add time variables (sin(hr) and weekday/weekend)</span>

        <span class="n">df</span><span class="p">,</span> <span class="n">day_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_timedata</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="c1"># step 4 -&gt; split into training and test set using split_time</span>
        <span class="n">df_t</span><span class="p">,</span> <span class="n">df_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partition_data</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>
        <span class="c1"># dropping negative rows after the data has been partitioned</span>
        <span class="n">df_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_neg_rows</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_t</span><span class="p">)</span>

        <span class="c1"># dropping negative and NaN rows for</span>
        <span class="n">df_eval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_neg_rows</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df_e</span><span class="p">,</span> <span class="n">drop_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">df_t</span><span class="p">,</span> <span class="n">df_e</span><span class="p">,</span> <span class="n">df_eval</span><span class="p">,</span> <span class="n">day_list</span></div>

<div class="viewcode-block" id="Dataset.rename_columns"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Dataset.rename_columns">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rename_columns</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        New method to map the column names in compiled_data to the names in the original code</span>
<span class="sd">        :param df:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">map_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Adjusted_Demand_MWh&quot;</span><span class="p">:</span> <span class="s2">&quot;Demand&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Pop&quot;</span><span class="p">:</span> <span class="s2">&quot;Population&quot;</span><span class="p">,</span>
            <span class="s2">&quot;T2&quot;</span><span class="p">:</span> <span class="s2">&quot;Temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;SWDOWN&quot;</span><span class="p">:</span> <span class="s2">&quot;Shortwave_Radiation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;GLW&quot;</span><span class="p">:</span> <span class="s2">&quot;Longwave_Radiation&quot;</span><span class="p">,</span>
            <span class="s2">&quot;WSPD&quot;</span><span class="p">:</span> <span class="s2">&quot;Wind_Speed&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Q2&quot;</span><span class="p">:</span> <span class="s2">&quot;Specific_Humidity&quot;</span>
        <span class="p">}</span>

        <span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">map_dict</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">&quot;columns&quot;</span><span class="p">)</span> <span class="k">if</span> <span class="s2">&quot;Adjusted_Demand_MWh&quot;</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">df</span>

        <span class="k">return</span> <span class="n">df_out</span></div>

<div class="viewcode-block" id="Dataset.preprocess_data"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Dataset.preprocess_data">[docs]</a>    <span class="k">def</span> <span class="nf">preprocess_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">day_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes the features and targets from df</span>

<span class="sd">        :return: df_t -&gt; training dataframe df_e -&gt; eval dataframe</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># sort the entire df by the column headers we require</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_dayofweek</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x_var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_var</span> <span class="o">+</span> <span class="p">[</span><span class="s2">&quot;Weekday&quot;</span><span class="p">,</span> <span class="s2">&quot;Holidays&quot;</span><span class="p">]</span>

        <span class="c1"># extract the training and test data. only including datetime, x_var (features) and y_var (targets)</span>
        <span class="n">df_t</span><span class="p">,</span> <span class="n">df_e</span><span class="p">,</span> <span class="n">df_eval</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_t</span><span class="p">[[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_var</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_var</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_e</span><span class="p">[[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_var</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_var</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_eval</span><span class="p">[[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_var</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_var</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">X_t</span><span class="p">,</span> <span class="n">X_e</span><span class="p">,</span> <span class="n">X_eval</span> <span class="o">=</span> <span class="n">df_t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_var</span><span class="p">],</span> <span class="n">df_e</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_var</span><span class="p">],</span> <span class="n">df_eval</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_var</span><span class="p">]</span>
        <span class="n">Y_t</span><span class="p">,</span> <span class="n">Y_e</span><span class="p">,</span> <span class="n">Y_eval</span> <span class="o">=</span> <span class="n">df_t</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_var</span><span class="p">],</span> <span class="n">df_e</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_var</span><span class="p">],</span> <span class="n">df_eval</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">y_var</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">df_t</span><span class="p">,</span> <span class="n">df_e</span><span class="p">,</span> <span class="n">df_eval</span><span class="p">,</span> <span class="n">X_t</span><span class="p">,</span> <span class="n">X_e</span><span class="p">,</span> <span class="n">X_eval</span><span class="p">,</span> <span class="n">Y_t</span><span class="p">,</span> <span class="n">Y_e</span><span class="p">,</span> <span class="n">Y_eval</span></div>

<div class="viewcode-block" id="Dataset.get_filename"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Dataset.get_filename">[docs]</a>    <span class="k">def</span> <span class="nf">get_filename</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        function to extract filename for that</span>
<span class="sd">        :return filename: str filename corresponding to that region</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">str_to_check</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">csv_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="si">}</span><span class="s2">_*.csv&quot;</span><span class="p">)</span>  <span class="c1"># pattern to search for</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">str_to_check</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># [0] list all filenames with the string str_to_check</span>

        <span class="k">return</span> <span class="n">filename</span></div>

<div class="viewcode-block" id="Dataset.sort_timeframe"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Dataset.sort_timeframe">[docs]</a>    <span class="k">def</span> <span class="nf">sort_timeframe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        function to filter dataframe by specified timeframe self.start_time and self.end Time</span>
<span class="sd">        :return df_out: sorted df</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span>
            <span class="n">df</span><span class="p">[[</span><span class="s2">&quot;Day&quot;</span><span class="p">,</span> <span class="s2">&quot;Month&quot;</span><span class="p">,</span> <span class="s2">&quot;Year&quot;</span><span class="p">,</span> <span class="s2">&quot;Hour&quot;</span><span class="p">]]</span>
        <span class="p">)</span>  <span class="c1"># Hour added</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="p">)</span>
            <span class="p">]</span>  <span class="c1"># sort df by start time endtime</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># rese</span>

        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="Dataset.drop_neg_rows"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Dataset.drop_neg_rows">[docs]</a>    <span class="k">def</span> <span class="nf">drop_neg_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">drop_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method drops -9999 values. it also drops &quot;extreme&quot; values, i.e. demand that lies outside +/- 5*sigma</span>
<span class="sd">        :param df:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># step 1: identify and remove Nan values</span>
        <span class="n">idx_nan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span> <span class="o">==</span> <span class="o">-</span><span class="mi">9999</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># identify which indices have NaN value</span>

        <span class="k">if</span> <span class="n">drop_nan</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx_nan</span><span class="p">])</span>  <span class="c1"># dropping data points with an NaN value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># step 2: identify where demand is zero, this is not feasible</span>
        <span class="n">idx_zero</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Demand&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">drop_nan</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx_zero</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#df.loc[df[&quot;Demand&quot;] == 0][&quot;Demand&quot;] = -9999</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Demand&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;Demand&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>

        <span class="n">mu_y</span><span class="p">,</span> <span class="n">sigma_y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Demand&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Demand&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="n">idx_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Demand&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">mu_y</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">sigma_y</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Demand&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">mu_y</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">sigma_y</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">drop_nan</span><span class="p">:</span>
            <span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">idx_1</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Demand&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">mu_y</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">sigma_y</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Demand&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">mu_y</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">sigma_y</span><span class="p">),</span> <span class="s2">&quot;Demand&quot;</span><span class="p">]</span><span class="o">=</span> <span class="o">-</span><span class="mi">9999</span>
            <span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">df_out</span></div>

<div class="viewcode-block" id="Dataset.partition_data"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Dataset.partition_data">[docs]</a>    <span class="k">def</span> <span class="nf">partition_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This method takes in df as an argument and splits them into a training and a test set</span>
<span class="sd">        :param df: contains entire dataset specified using start_time and end_time</span>
<span class="sd">        :return df_t, df_e: dfs for trining and test data respectively</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df_t</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_time</span><span class="p">)]</span>
        <span class="n">df_e</span> <span class="o">=</span> <span class="n">df</span><span class="p">[(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_time</span><span class="p">)]</span>

        <span class="k">return</span> <span class="n">df_t</span><span class="p">,</span> <span class="n">df_e</span></div>

<div class="viewcode-block" id="Dataset.remove_federal_holidays"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Dataset.remove_federal_holidays">[docs]</a>    <span class="k">def</span> <span class="nf">remove_federal_holidays</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to identify federal holidays. if federal holidays, the df[Holidays] = 1</span>
<span class="sd">        :param df: input dataframe</span>
<span class="sd">        :param year: year for which the holiday list needs to be determined. default -&gt; global variable YEAR</span>
<span class="sd">        :return: Dataframe without holidays included</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">year_min</span><span class="p">,</span> <span class="n">year_max</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">year_min</span><span class="p">,</span> <span class="n">year_max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">holiday_list</span> <span class="o">=</span> <span class="n">holidays</span><span class="o">.</span><span class="n">US</span><span class="p">(</span><span class="n">years</span><span class="o">=</span><span class="n">years</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">str</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;datetime64&quot;</span><span class="p">):</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">])</span>

        <span class="nb">bool</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">holiday_list</span><span class="p">)</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Holidays&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span> <span class="o">*</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="Dataset.troubleshoot_by_plot"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Dataset.troubleshoot_by_plot">[docs]</a>    <span class="k">def</span> <span class="nf">troubleshoot_by_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        plot to troubleshoot if the training data has missing values.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_t</span><span class="p">[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_t</span><span class="p">[</span><span class="s2">&quot;Demand&quot;</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date/Time&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Demand (MW)&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Dataset.preprocess_timedata"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Dataset.preprocess_timedata">[docs]</a>    <span class="k">def</span> <span class="nf">preprocess_timedata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>

        <span class="n">day_list</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="s2">&quot;Hour&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_var</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin_model_bool</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># this block of code indicates if we want to featurize a sine function or the raw input</span>
            <span class="n">hr</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Hour&quot;</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Hour&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">hr</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">24</span><span class="p">)</span>  <span class="c1"># 24 hours is pi</span>

        <span class="k">if</span> <span class="s2">&quot;Month&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_var</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin_model_bool</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># this block of code indicates if we want to make the function sinosoidal</span>
            <span class="n">mnth</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">]</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">((</span><span class="n">mnth</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mi">12</span><span class="p">))</span>  <span class="c1"># 12 months is pi</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">add_dayofweek</span><span class="p">:</span>
            <span class="n">dayofweek</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofweek</span><span class="o">.</span><span class="n">values</span>

            <span class="c1"># dayofweek 0: monday, 6: sunday</span>
            <span class="n">weekday</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dayofweek</span><span class="p">)</span>
            <span class="n">weekday</span><span class="p">[</span><span class="n">dayofweek</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Weekday&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">weekday</span>

            <span class="c1"># Create a day of week variable</span>
            <span class="n">day_of_week</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dayofweek</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">7</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">):</span>
                <span class="n">tmp_val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">dayofweek</span><span class="p">)</span>
                <span class="n">tmp_val</span><span class="p">[</span><span class="n">dayofweek</span> <span class="o">==</span> <span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">day_of_week</span><span class="p">[:,</span> <span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp_val</span>

            <span class="c1"># concat day of week with df</span>
            <span class="n">df_dayofweek</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">day_of_week</span><span class="p">)</span>

            <span class="c1"># weeklist</span>
            <span class="n">day_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mon&quot;</span><span class="p">,</span> <span class="s2">&quot;Tue&quot;</span><span class="p">,</span> <span class="s2">&quot;Wed&quot;</span><span class="p">,</span> <span class="s2">&quot;Thu&quot;</span><span class="p">,</span> <span class="s2">&quot;Fri&quot;</span><span class="p">,</span> <span class="s2">&quot;Sat&quot;</span><span class="p">,</span> <span class="s2">&quot;Sun&quot;</span><span class="p">]</span>
            <span class="n">df_dayofweek</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">day_list</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">df</span><span class="p">,</span> <span class="n">df_dayofweek</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="c1"># federal holidays added as a new feature</span>
            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remove_federal_holidays</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">df</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">day_list</span></div>

<div class="viewcode-block" id="Dataset.compute_pearson"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Dataset.compute_pearson">[docs]</a>    <span class="k">def</span> <span class="nf">compute_pearson</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the pearson coeff for each x in self.x_var and each y in self.y_var</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_var</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_var</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;The PC between </span><span class="si">{}</span><span class="s2"> and </span><span class="si">{}</span><span class="s2"> is </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">pearsonr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df</span><span class="p">[</span><span class="n">y</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="Hyperparameters"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Hyperparameters">[docs]</a><span class="k">class</span> <span class="nc">Hyperparameters</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    class for hyperparameter search</span>
<span class="sd">    only used when we need to optimize hyperpaaremters for a specific balancing authority</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_str</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param model_str: str -&gt; indicating model type. currently only mlp is supported</span>
<span class="sd">        :param X: features in training set</span>
<span class="sd">        :param Y: targets in training set</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># assigning model variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_name</span> <span class="o">=</span> <span class="n">model_str</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span> <span class="o">=</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span>

        <span class="k">if</span> <span class="n">model_str</span> <span class="o">==</span> <span class="s2">&quot;mlp&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mlp</span><span class="p">()</span>

<div class="viewcode-block" id="Hyperparameters.mlp"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Hyperparameters.mlp">[docs]</a>    <span class="k">def</span> <span class="nf">mlp</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        performs hyperparameter optimization for an mlp</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="n">max_iter</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>  <span class="c1"># instantiate MLP model with 100 training epochs</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_mlp_params</span><span class="p">()</span>  <span class="c1"># params -&gt; a dict containing search space of all hyperparameters</span>
        <span class="n">clf</span> <span class="o">=</span> <span class="n">GridSearchCV</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># performing grid search cross-validation for one BA</span>
        <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y</span><span class="p">)</span>  <span class="c1"># fit gridsearch obj with data (X, Y)</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Hyperparameters.set_mlp_params"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Hyperparameters.set_mlp_params">[docs]</a>    <span class="k">def</span> <span class="nf">set_mlp_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        function to set hyperparameters for MLP</span>
<span class="sd">        currently only MLP with 1 hidden layer is supported. the only hyperparameter is size of hidden layer</span>
<span class="sd">        :return params: dict containing search space for hyperparameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># instantiate params</span>
        <span class="c1"># define hyperparameters search space. currently only supporting MLP with 1 hidden l</span>
        <span class="n">params</span><span class="p">[</span><span class="s2">&quot;hidden_layer_sizes&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">712</span><span class="p">,</span> <span class="mi">1028</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">params</span></div></div>


<div class="viewcode-block" id="MlLib"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.MlLib">[docs]</a><span class="k">class</span> <span class="nc">MlLib</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    class to train and evaluate ML models</span>
<span class="sd">    :param X_t: df -&gt; training data,</span>
<span class="sd">    :param Y_t: df -&gt; training targets</span>
<span class="sd">    :param X_e: df -&gt; test data</span>
<span class="sd">    :param Y_e: df -&gt; test targets</span>
<span class="sd">    :param model: str type of model to pick</span>
<span class="sd">    :param datetime: array of dates for the</span>
<span class="sd">    :param_fig_names: dict containing names of all the figures we want, including timeseries, seasonal prob dist, and cdf</span>
<span class="sd">    :param dict_res: dict containing data needed for training and avaluation of residual model</span>

<span class="sd">    :param generate_plots:              Choice to generate and save plots</span>
<span class="sd">    :type generate_plots:               bool</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
             <span class="bp">self</span><span class="p">,</span>
             <span class="n">X_t</span><span class="p">,</span>
             <span class="n">Y_t</span><span class="p">,</span>
             <span class="n">X_e</span><span class="p">,</span>
             <span class="n">fig_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">datetime</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">Y_e</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">Y_eval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">model</span><span class="o">=</span><span class="s2">&quot;mlp&quot;</span><span class="p">,</span>
             <span class="n">dict_res</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">generate_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
             <span class="n">plot_gt</span><span class="o">=</span><span class="kc">False</span>
     <span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">generate_plots</span> <span class="o">=</span> <span class="n">generate_plots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_gt</span> <span class="o">=</span> <span class="n">plot_gt</span>

        <span class="c1"># set data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_e</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">X_t</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">X_e</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">Y_t</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">Y_e</span><span class="o">.</span><span class="n">values</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Y_eval</span> <span class="o">=</span> <span class="n">Y_eval</span><span class="o">.</span><span class="n">values</span> <span class="k">if</span> <span class="n">Y_eval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">Y_eval</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dict_res</span> <span class="o">=</span> <span class="n">dict_res</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">datetime</span>
        <span class="c1"># set variable of fig_names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig_names</span> <span class="o">=</span> <span class="n">fig_names</span>

        <span class="c1"># get the dict for residuals, if we want to fit residuals to the model</span>

        <span class="c1"># scale features. normalized features in lowercase</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scale_features</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">y_e</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;x_t&quot;</span><span class="p">],</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;x_e&quot;</span><span class="p">],</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;y_t&quot;</span><span class="p">],</span>
            <span class="n">out</span><span class="p">[</span><span class="s2">&quot;y_e&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out</span> <span class="o">=</span> <span class="n">out</span>
        <span class="c1"># train and predict using the model. currently &#39;mlp&#39; and &#39;linear&#39; supported</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pick_model</span><span class="p">()</span>

        <span class="c1"># evaluation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">analyze_results</span><span class="p">()</span>

<div class="viewcode-block" id="MlLib.linear_model"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.MlLib.linear_model">[docs]</a>    <span class="k">def</span> <span class="nf">linear_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X_e</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        training and test data of a linear model. can be used for either the main model or the residual model</span>
<span class="sd">        :param X: training features</span>
<span class="sd">        :param Y: training targets</span>
<span class="sd">        :param X_e: test features</span>
<span class="sd">        :return y_p: predictions over test set</span>
<span class="sd">        :return reg.coef_: regression coefficients of a linear model</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># instantiate and fit linear model</span>
        <span class="n">reg</span> <span class="o">=</span> <span class="n">LR</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">Y</span><span class="p">)</span>
        <span class="c1"># get predictions</span>
        <span class="n">y_p</span> <span class="o">=</span> <span class="n">reg</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">y_p</span><span class="p">,</span> <span class="n">reg</span><span class="o">.</span><span class="n">coef_</span></div>

<div class="viewcode-block" id="MlLib.mlp_model"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.MlLib.mlp_model">[docs]</a>    <span class="k">def</span> <span class="nf">mlp_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X_e</span><span class="p">,</span> <span class="n">X_eval</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        trains the MLP model. also calls the linear residual model to adjust for population correction</span>
<span class="sd">        :param X: np.array -&gt; train features</span>
<span class="sd">        :param Y: np.array -&gt; train targets</span>
<span class="sd">        :param X_e: np.array -&gt; test features</span>
<span class="sd">        :return: y_p: np.array -&gt; predictions over test set</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># currently hyperparameter selection is deactivate</span>
        <span class="c1"># hyp_mlp = hyperparameters(model_str=&#39;mlp&#39;, X=X, Y=Y)</span>

        <span class="c1"># instantiate and train the mlp model. we found 256 to be a good hyperparameter pick over some of larger bas</span>
        <span class="c1"># performing hyperparameter search over all BAs may be computationally expensive</span>
        <span class="c1"># accuracies for most BAs not sensitive to hyperparameters</span>
        <span class="n">mlp</span> <span class="o">=</span> <span class="n">MLP</span><span class="p">(</span><span class="n">hidden_layer_sizes</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">max_iter</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">validation_fraction</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
        <span class="n">mlp</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
        <span class="n">y_p</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_e</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_res</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># fit residuals using linear_residual</span>
            <span class="n">y_tmp</span> <span class="o">=</span> <span class="n">mlp</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>  <span class="c1"># predict on training data</span>

            <span class="c1"># compute residuals: epsilon</span>
            <span class="n">epsilon</span> <span class="o">=</span> <span class="n">Y</span> <span class="o">-</span> <span class="n">y_tmp</span>  <span class="c1"># residuals in the training data</span>

            <span class="c1"># train linear model to find residuals</span>
            <span class="n">epsilon_e</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_residual</span><span class="p">(</span><span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>
            <span class="n">y_p</span> <span class="o">=</span> <span class="n">y_p</span> <span class="o">+</span> <span class="n">epsilon_e</span>

        <span class="k">return</span> <span class="n">y_p</span></div>

<div class="viewcode-block" id="MlLib.linear_residual"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.MlLib.linear_residual">[docs]</a>    <span class="k">def</span> <span class="nf">linear_residual</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epsilon</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        function to fit the residuals of MLP predictions</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># fit the residuals with a linear model if a dict_res is provided</span>
        <span class="c1"># if self.dict_res is not None:</span>
        <span class="n">Xres_t</span><span class="p">,</span> <span class="n">Xres_e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_res</span><span class="p">[</span><span class="s2">&quot;Xres_t&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dict_res</span><span class="p">[</span><span class="s2">&quot;Xres_e&quot;</span><span class="p">]</span>
        <span class="n">epsilon_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_model</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="n">Xres_t</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">X_e</span><span class="o">=</span><span class="n">Xres_e</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">epsilon_p</span></div>

<div class="viewcode-block" id="MlLib.pick_model"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.MlLib.pick_model">[docs]</a>    <span class="k">def</span> <span class="nf">pick_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;linear&quot;</span><span class="p">:</span>
            <span class="n">y_p</span><span class="p">,</span> <span class="n">coeff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">linear_model</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_t</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_t</span><span class="p">,</span> <span class="n">X_e</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;svr&quot;</span><span class="p">:</span>
            <span class="n">y_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">svr_model</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_t</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_t</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">X_e</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;gpr&quot;</span><span class="p">:</span>
            <span class="n">y_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gpr_model</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_t</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_t</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">X_e</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_e</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;mlp&quot;</span><span class="p">:</span>
            <span class="n">y_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mlp_model</span><span class="p">(</span><span class="n">X</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_t</span><span class="p">,</span> <span class="n">Y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_t</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span> <span class="n">X_e</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_p</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">y_p</span></div>

<div class="viewcode-block" id="MlLib.scale_features"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.MlLib.scale_features">[docs]</a>    <span class="k">def</span> <span class="nf">scale_features</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># get the mean and std of training set</span>
        <span class="n">mu_x</span><span class="p">,</span> <span class="n">sigma_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_t</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_t</span><span class="p">)</span>
        <span class="n">mu_y</span><span class="p">,</span> <span class="n">sigma_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_t</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_t</span><span class="p">)</span>

        <span class="c1"># normalize</span>
        <span class="n">x_t</span><span class="p">,</span> <span class="n">x_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">X_t</span> <span class="o">-</span> <span class="n">mu_x</span><span class="p">),</span> <span class="n">sigma_x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">X_e</span> <span class="o">-</span> <span class="n">mu_x</span><span class="p">),</span> <span class="n">sigma_x</span>
        <span class="p">)</span>
        <span class="n">y_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_t</span> <span class="o">-</span> <span class="n">mu_y</span><span class="p">),</span> <span class="n">sigma_y</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_e</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">y_e</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_e</span> <span class="o">-</span> <span class="n">mu_y</span><span class="p">),</span> <span class="n">sigma_y</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_e</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">dict_out</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;mu_x&quot;</span><span class="p">:</span> <span class="n">mu_x</span><span class="p">,</span>
            <span class="s2">&quot;mu_y&quot;</span><span class="p">:</span> <span class="n">mu_y</span><span class="p">,</span>
            <span class="s2">&quot;sigma_x&quot;</span><span class="p">:</span> <span class="n">sigma_x</span><span class="p">,</span>
            <span class="s2">&quot;sigma_y&quot;</span><span class="p">:</span> <span class="n">sigma_y</span><span class="p">,</span>
            <span class="s2">&quot;x_t&quot;</span><span class="p">:</span> <span class="n">x_t</span><span class="p">,</span>
            <span class="s2">&quot;y_t&quot;</span><span class="p">:</span> <span class="n">y_t</span><span class="p">,</span>
            <span class="s2">&quot;x_e&quot;</span><span class="p">:</span> <span class="n">x_e</span><span class="p">,</span>
            <span class="s2">&quot;y_e&quot;</span><span class="p">:</span> <span class="n">y_e</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">dict_out</span></div>

<div class="viewcode-block" id="MlLib.unscale_targets"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.MlLib.unscale_targets">[docs]</a>    <span class="k">def</span> <span class="nf">unscale_targets</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">y_p</span><span class="p">):</span>

        <span class="n">mu_y</span><span class="p">,</span> <span class="n">sigma_y</span> <span class="o">=</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;mu_y&quot;</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="s2">&quot;sigma_y&quot;</span><span class="p">]</span>
        <span class="n">Y_p</span> <span class="o">=</span> <span class="n">y_p</span> <span class="o">*</span> <span class="n">sigma_y</span> <span class="o">+</span> <span class="n">mu_y</span>

        <span class="k">return</span> <span class="n">Y_p</span></div>

<div class="viewcode-block" id="MlLib.analyze_results"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.MlLib.analyze_results">[docs]</a>    <span class="k">def</span> <span class="nf">analyze_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to compute the evaluation metrics, and prepare plots</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># define locator and formatter for plots</span>
        <span class="n">locator</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">AutoDateLocator</span><span class="p">()</span>
        <span class="n">formatter</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">ConciseDateFormatter</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>

        <span class="c1"># first revert to the absolute values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Y_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unscale_targets</span><span class="p">(</span><span class="n">out</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out</span><span class="p">,</span> <span class="n">y_p</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">y_p</span><span class="p">)</span>

        <span class="c1"># complile results and predictions into a timeframe</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Datetime&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
            <span class="s2">&quot;Y_p&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_p</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
            <span class="s2">&quot;Y_e&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_e</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">df_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_plots</span><span class="p">:</span>
            <span class="c1"># evaluate metrics</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">})</span>

            <span class="c1"># set mdates formatter</span>
            <span class="n">locator</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">AutoDateLocator</span><span class="p">()</span>
            <span class="n">formatter</span> <span class="o">=</span> <span class="n">mdates</span><span class="o">.</span><span class="n">ConciseDateFormatter</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>

            <span class="c1"># quick plot:</span>
            <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_e</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_gt</span><span class="p">:</span>
                <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">masked_where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_e</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_e</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Ground Truth&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_p</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Predictions&quot;</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">locator</span><span class="p">)</span>
            <span class="n">ax1</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>

            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Date/Time&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Electricity Demand (MWh)&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_names</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Created figure: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_names</span><span class="p">[</span><span class="s2">&quot;timeSeries&quot;</span><span class="p">])</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fig_names</span><span class="p">[</span><span class="s2">&quot;timeSeries&quot;</span><span class="p">])</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

            <span class="c1"># close figure</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c1"># evaluate the model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluation_metrics</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="MlLib.evaluation_metrics"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.MlLib.evaluation_metrics">[docs]</a>    <span class="k">def</span> <span class="nf">evaluation_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        method to compute the evaluation metrics</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># remove all the nan in self.Y_eval before evaluation</span>
        <span class="n">idx_notnan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_eval</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">9999</span><span class="p">)</span>
        <span class="n">Y_p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_p</span><span class="p">[</span><span class="n">idx_notnan</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">Y_eval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_eval</span><span class="p">[</span><span class="n">idx_notnan</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">()</span>

        <span class="c1"># first the absolute root-mean-squared error</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rms_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">Y_p</span><span class="p">,</span> <span class="n">Y_eval</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rms_norm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rms_abs</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">Y_eval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mape</span> <span class="o">=</span> <span class="n">mean_absolute_percentage_error</span><span class="p">(</span><span class="n">Y_p</span><span class="p">,</span> <span class="n">Y_eval</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">r2_val</span> <span class="o">=</span> <span class="n">r2_score</span><span class="p">(</span><span class="n">Y_p</span><span class="p">,</span> <span class="n">Y_eval</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RMS-ABS: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rms_abs</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;RMS NORM: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rms_norm</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;MAPE: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mape</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;R2 value: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">r2_val</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="MlLib.evaluate_peaks"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.MlLib.evaluate_peaks">[docs]</a>    <span class="k">def</span> <span class="nf">evaluate_peaks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is to compute the difference in peak values and in peak timimngs</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">df_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;Datetime&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">))</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">df_results</span><span class="p">[</span><span class="s2">&quot;Y_e&quot;</span><span class="p">]))</span>
        <span class="n">idx_Ye</span> <span class="o">=</span> <span class="n">df_grp</span><span class="p">[</span><span class="s2">&quot;Y_e&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">idx_Yp</span> <span class="o">=</span> <span class="n">df_grp</span><span class="p">[</span><span class="s2">&quot;Y_p&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">peak_Ye</span><span class="p">,</span> <span class="n">peak_Yp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_e</span><span class="p">[</span><span class="n">idx_Ye</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_p</span><span class="p">[</span><span class="n">idx_Yp</span><span class="p">]</span>

        <span class="c1"># define peaktimes</span>
        <span class="n">time_Ye</span><span class="p">,</span> <span class="n">time_Yp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="p">[</span><span class="n">idx_Ye</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">datetime</span><span class="p">[</span><span class="n">idx_Yp</span><span class="p">]</span>

        <span class="n">delta_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">idx_Yp</span> <span class="o">-</span> <span class="n">idx_Ye</span><span class="p">)</span>
        <span class="c1"># if it&#39;s more than 12 hours</span>
        <span class="n">delta_time</span><span class="p">[</span><span class="n">delta_time</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">-</span> <span class="n">delta_time</span><span class="p">[</span><span class="n">delta_time</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">delta_time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">mean_squared_error</span><span class="p">(</span><span class="n">peak_Ye</span><span class="p">,</span> <span class="n">peak_Yp</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peak_err</span> <span class="o">=</span> <span class="n">mean_absolute_percentage_error</span><span class="p">(</span><span class="n">peak_Ye</span><span class="p">,</span> <span class="n">peak_Yp</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="MlLib.monthly_plots"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.MlLib.monthly_plots">[docs]</a>    <span class="k">def</span> <span class="nf">monthly_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># set rcparams</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">})</span>

        <span class="n">df_grp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_results</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Grouper</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s2">&quot;Datetime&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;M&quot;</span><span class="p">))</span>
        <span class="n">df_month</span> <span class="o">=</span> <span class="p">[</span><span class="n">grp</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">grp</span> <span class="ow">in</span> <span class="n">df_grp</span><span class="p">]</span>

        <span class="c1"># extract string for fig_name</span>
        <span class="n">main_str</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fig_names</span><span class="p">[</span><span class="s2">&quot;dist&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;.svg&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_month</span><span class="p">):</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax1</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span>
                <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y_e&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y_p&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y_e&quot;</span><span class="p">],</span>
                <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">bins</span><span class="o">=</span><span class="mi">75</span><span class="p">,</span>
                <span class="n">histtype</span><span class="o">=</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="s2">&quot;tab:blue&quot;</span><span class="p">,</span>
                <span class="n">stacked</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">fig_hist</span> <span class="o">=</span> <span class="n">main_str</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">MONTH_LIST</span><span class="p">[</span><span class="n">m</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.svg&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_hist</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

            <span class="c1"># print median value</span>
            <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y_e&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y_p&quot;</span><span class="p">])</span> <span class="o">/</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;Y_e&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="Analysis"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Analysis">[docs]</a><span class="k">class</span> <span class="nc">Analysis</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">data_dir</span><span class="p">,</span>
            <span class="n">out_dir</span><span class="p">,</span>
            <span class="n">start_time</span><span class="o">=</span><span class="s2">&quot;2016-01-01 00:00:00&quot;</span><span class="p">,</span>
            <span class="n">end_time</span><span class="o">=</span><span class="s2">&quot;2019-12-31 23:00:00&quot;</span><span class="p">,</span>
            <span class="n">split_time</span><span class="o">=</span><span class="s2">&quot;2018-12-31 23:00:00&quot;</span><span class="p">,</span>
            <span class="n">region</span><span class="o">=</span><span class="s2">&quot;PJM&quot;</span><span class="p">,</span>
            <span class="n">generate_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">plot_gt</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Train and evaluate each individual BAs. Generates output CSV files under directory outputs</span>
<span class="sd">        Trains the &quot;residual model&quot; as well for population correction.</span>

<span class="sd">        :param data_dir:                str indicating full path to dir for data source</span>
<span class="sd">        :param out_dir:                 str indicating full path to dir for output csvs and figures</span>
<span class="sd">        :param start_time:              str indicating the start-time for analysis. Format YYYY-MM-DD HH:MM:SS.</span>
<span class="sd">                                        Default: 2016-01-01 00:00:00</span>
<span class="sd">        :param end_time:                str indicating the end time for analysis. Default: 2019-12-31 23:00:00</span>
<span class="sd">        :param split_time:              str indicating the timestamp splitting train and test data.</span>
<span class="sd">                                        Default: 2018-12-31 23:00:00</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">end_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_time</span> <span class="o">=</span> <span class="n">split_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">generate_plots</span> <span class="o">=</span> <span class="n">generate_plots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_gt</span> <span class="o">=</span> <span class="n">plot_gt</span>

        <span class="c1"># note, region is same as BA!</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">region</span> <span class="o">=</span> <span class="n">region</span>

        <span class="c1"># specify feature set for residuals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x_res</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Population&quot;</span><span class="p">,</span> <span class="s2">&quot;Hour&quot;</span><span class="p">,</span> <span class="s2">&quot;Month&quot;</span><span class="p">,</span> <span class="s2">&quot;Year&quot;</span><span class="p">]</span>

        <span class="c1"># specify dataset for both main MLP and residual linear model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span>
            <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
            <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
            <span class="n">end_time</span><span class="o">=</span><span class="n">end_time</span><span class="p">,</span>
            <span class="n">split_time</span><span class="o">=</span><span class="n">split_time</span><span class="p">,</span>
            <span class="n">csv_dir</span><span class="o">=</span><span class="n">data_dir</span>
        <span class="p">)</span>

        <span class="c1"># data for residual model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data_res</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span>
            <span class="n">region</span><span class="o">=</span><span class="n">region</span><span class="p">,</span>
            <span class="n">x_var</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">x_res</span><span class="p">,</span>
            <span class="n">linear_mode_bool</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
            <span class="n">end_time</span><span class="o">=</span><span class="n">end_time</span><span class="p">,</span>
            <span class="n">split_time</span><span class="o">=</span><span class="n">split_time</span><span class="p">,</span> <span class="n">csv_dir</span><span class="o">=</span><span class="n">data_dir</span>
        <span class="p">)</span>

        <span class="c1"># define training and test data for residual fits</span>
        <span class="c1"># training and test data for main MLP model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">X_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">X_e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_e</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">X_t</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Y_t</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">X_e</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Y_e</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">Y_eval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">Y_eval</span>
        <span class="c1"># training and test data for residual model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Xres_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Yres_t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xres_e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Yres_e</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_res</span><span class="o">.</span><span class="n">X_t</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_res</span><span class="o">.</span><span class="n">Y_t</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_res</span><span class="o">.</span><span class="n">X_e</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_res</span><span class="o">.</span><span class="n">Y_e</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># resetting indices for test data: both main model and residual model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">df_e</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_res_e</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">df_e</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data_res</span><span class="o">.</span><span class="n">df_e</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="p">)</span>

        <span class="c1"># list of models for which analysis is to be performed. currently only &#39;linear&#39; and &#39;mlp&#39; supported</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_of_models</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mlp&quot;</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">=</span> <span class="n">out_dir</span>

        <span class="c1"># create output dir if it not already created</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">)</span>

        <span class="c1"># test multiple models. currently only testing for &#39;mlp&#39; model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_multiple_models</span><span class="p">()</span>

<div class="viewcode-block" id="Analysis.test_multiple_models"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Analysis.test_multiple_models">[docs]</a>    <span class="k">def</span> <span class="nf">test_multiple_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">Yp_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># get labels for predictions based on type of model</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">str_name</span> <span class="o">+</span> <span class="s2">&quot; predictions&quot;</span> <span class="k">for</span> <span class="n">str_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_of_models</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_of_models</span><span class="p">):</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;----CHECKING PREDICTIVE MODELS-----&quot;</span><span class="p">)</span>
            <span class="n">fig_names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_fignames</span><span class="p">(</span><span class="n">model_name</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="n">m</span><span class="p">])</span>
            <span class="c1"># set up the dict for error correction</span>
            <span class="n">err_correct</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;Xres_t&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xres_t</span><span class="p">,</span> <span class="s2">&quot;Xres_e&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Xres_e</span><span class="p">}</span>

            <span class="c1"># instantiate ml_lib object for to train the model and get predictions over the test set</span>
            <span class="n">ml</span> <span class="o">=</span> <span class="n">MlLib</span><span class="p">(</span>
                <span class="n">X_t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X_t</span><span class="p">,</span>
                <span class="n">Y_t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_t</span><span class="p">,</span>
                <span class="n">X_e</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">X_e</span><span class="p">,</span>
                <span class="n">Y_e</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_e</span><span class="p">,</span>
                <span class="n">Y_eval</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">Y_eval</span><span class="p">,</span>
                <span class="n">datetime</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">df_e</span><span class="p">[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">],</span>
                <span class="n">fig_names</span><span class="o">=</span><span class="n">fig_names</span><span class="p">,</span>
                <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
                <span class="n">dict_res</span><span class="o">=</span><span class="n">err_correct</span><span class="p">,</span>
                <span class="n">generate_plots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_plots</span><span class="p">,</span>
                <span class="n">plot_gt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_gt</span>
            <span class="p">)</span>

            <span class="c1"># get the predictions from the ML model</span>
            <span class="n">Y_p</span> <span class="o">=</span> <span class="n">ml</span><span class="o">.</span><span class="n">Y_p</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df_e</span><span class="p">[</span><span class="n">labels</span><span class="p">[</span><span class="n">m</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Y_p</span>

            <span class="c1"># currently regression is commented out, but you can have a regression plot if you chose</span>
            <span class="c1"># self.plot_reg(Y_a=self.Y_e, Y_p=Y_p, label=labels[m])</span>

            <span class="c1"># write to file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_output_to_file</span><span class="p">(</span><span class="n">Y_p</span><span class="o">=</span><span class="n">Y_p</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">)</span>

            <span class="c1"># export for bar chart</span>
            <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;mlp&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">R2</span> <span class="o">=</span> <span class="n">ml</span><span class="o">.</span><span class="n">r2_val</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">MAPE</span> <span class="o">=</span> <span class="n">ml</span><span class="o">.</span><span class="n">mape</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Analysis.set_fignames"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Analysis.set_fignames">[docs]</a>    <span class="k">def</span> <span class="nf">set_fignames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_name</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Set figure names for timeseries plots and probability distributions of error residuals by month</span>

<span class="sd">        :param model_name: str -&gt; model name (e.g. &#39;linear&#39;, &#39;mlp&#39;)</span>
<span class="sd">        :return: fig_names: dict -&gt; containing list of figures for &#39;timeSeries&#39; and &#39;dist&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fig_names</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">fig_names</span><span class="p">[</span><span class="s2">&quot;timeSeries&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">_timeseries.svg&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">fig_names</span><span class="p">[</span><span class="s2">&quot;dist&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">_probdist.svg&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">fig_names</span></div>

<div class="viewcode-block" id="Analysis.plot_reg"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Analysis.plot_reg">[docs]</a>    <span class="k">def</span> <span class="nf">plot_reg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y_a</span><span class="p">,</span> <span class="n">Y_p</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method for regression Plots</span>
<span class="sd">        :param Y_a: array containing ground truth</span>
<span class="sd">        :param Y_p:</span>
<span class="sd">        :param label:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;font.size&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">})</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">Y_a</span><span class="p">,</span> <span class="n">Y_p</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y_a</span><span class="p">,</span> <span class="n">Y_a</span><span class="p">,</span> <span class="s2">&quot;r-&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y_a</span><span class="p">,</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">Y_a</span><span class="p">,</span> <span class="s2">&quot;r--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">Y_a</span><span class="p">,</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">Y_a</span><span class="p">,</span> <span class="s2">&quot;r--&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Actual forecast of electricity Demand (MWh)&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Predictions of electricity demand (MWh)&quot;</span><span class="p">)</span>

        <span class="n">fig_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">.svg&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_name</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="Analysis.write_output_to_file"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Analysis.write_output_to_file">[docs]</a>    <span class="k">def</span> <span class="nf">write_output_to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Y_p</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This function is used to write output</span>
<span class="sd">        Y_p: predictions (np array)</span>
<span class="sd">        model: str to label which model it is</span>
<span class="sd">        :return: None</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># need to flatten self.Y_e, as the dimensions are (..,1)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;Datetime&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">df_e</span><span class="p">[</span><span class="s2">&quot;Datetime&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="s2">&quot;Adjusted_Demand_MWh&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">Y_e</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(),</span>
            <span class="s2">&quot;NN-Predicted_Demand_MWh&quot;</span><span class="p">:</span> <span class="n">Y_p</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># export as pandas dataframe and write to file</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">csv_filename</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">region</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_predictions.csv&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_filename</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="kc">None</span></div></div>


<div class="viewcode-block" id="Process"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Process">[docs]</a><span class="k">class</span> <span class="nc">Process</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">start_time</span><span class="o">=</span><span class="s2">&quot;2016-01-01 00:00:00&quot;</span><span class="p">,</span>
            <span class="n">end_time</span><span class="o">=</span><span class="s2">&quot;2019-12-31 23:00:00&quot;</span><span class="p">,</span>
            <span class="n">split_time</span><span class="o">=</span><span class="s2">&quot;2018-12-31 23:00:00&quot;</span><span class="p">,</span>
            <span class="n">batch_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">data_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">out_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">target_ba_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">generate_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">plot_gt</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run multiple BA</span>

<span class="sd">        :param start_time:              str indicating the start-time for analysis. Format YYYY-MM-DD HH:MM:SS.</span>
<span class="sd">                                        Default: 2016-01-01 00:00:00</span>
<span class="sd">        :param end_time:                str indicating the end time for analysis. Default: 2019-12-31 23:00:00</span>
<span class="sd">        :param split_time:              str indicating the timestamp splitting train and test data.</span>
<span class="sd">                                        Default: 2018-12-31 23:00:00</span>
<span class="sd">        :param batch_run:               Indicating if we want to run the simulations for all BAs, or we handpick the BAs</span>
<span class="sd">                                        If batch_run = True, the code will search for all BAs in &#39;dir&#39;</span>
<span class="sd">                                        If batch_run = False, we need to specify which BA to run</span>
<span class="sd">        :type batch_run:                bool</span>

<span class="sd">        :param data_dir:                Full path to the directory containing the target</span>
<span class="sd">                                        CSV files</span>
<span class="sd">        :type data_dir:                 str</span>

<span class="sd">        :param out_dir:                 Full path to the directory where the outputs are to be written</span>
<span class="sd">        :type out_dir:                  str</span>

<span class="sd">        :param target_ba_list:          A list of BA names to run if `batch_run` is False</span>
<span class="sd">        :type target_ba_list:           list</span>

<span class="sd">        :param generate_plots:          Choice to generate and save plots</span>
<span class="sd">        :type generate_plots:           bool</span>

<span class="sd">        :param plot_gt:                 Choice to plot ground truth data in plot along with MLP predictions</span>
<span class="sd">        :type plot_gt:                  bool</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">start_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end_time</span> <span class="o">=</span> <span class="n">end_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">split_time</span> <span class="o">=</span> <span class="n">split_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span> <span class="o">=</span> <span class="n">data_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span> <span class="o">=</span> <span class="n">out_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_ba_list</span> <span class="o">=</span> <span class="n">target_ba_list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_plots</span> <span class="o">=</span> <span class="n">generate_plots</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot_gt</span> <span class="o">=</span> <span class="n">plot_gt</span>

        <span class="c1"># output summary file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_summary_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span> <span class="s1">&#39;summary.csv&#39;</span><span class="p">)</span>

        <span class="c1"># checking dir to get list of CSV files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pat_to_check</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span> <span class="s1">&#39;*.csv&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">batch_run</span><span class="p">:</span>
            <span class="c1"># case to run for all BAs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ba_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">search_for_pattern</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ba_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s2">&quot;No csvs found in the directory!&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># case for handpick BAs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ba_list</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_ba_list</span>

        <span class="c1"># loop over all BAs. generates summary.csv to show accuracy of all BAs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">summary_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gen_results</span><span class="p">()</span>  <span class="c1"># steo ii: gen_results</span>

<div class="viewcode-block" id="Process.search_for_pattern"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Process.search_for_pattern">[docs]</a>    <span class="k">def</span> <span class="nf">search_for_pattern</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets self.ba_list to get a list of BAs for training and evaluation.</span>

<span class="sd">        :return:            List of BAs to process</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">list_of_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pat_to_check</span><span class="p">))</span>

        <span class="n">BA_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">list_of_files</span><span class="p">:</span>
            <span class="n">main_str</span> <span class="o">=</span> <span class="n">filename</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">main_str</span> <span class="o">=</span> <span class="n">main_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># get the BA name</span>
            <span class="n">BA_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">main_str</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">BA_list</span></div>

<div class="viewcode-block" id="Process.gen_results"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.Process.gen_results">[docs]</a>    <span class="k">def</span> <span class="nf">gen_results</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Writes all outputs to csvs + a summary file with the evaluation metrics.</span>

<span class="sd">        :return:</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ba_out</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">mape</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">BA_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ba_list</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;BA: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">BA_name</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># perform analysis for each BA, keep track of all BAs and corresponding accuracy metrics</span>
                <span class="n">ba</span> <span class="o">=</span> <span class="n">Analysis</span><span class="p">(</span>
                    <span class="n">region</span><span class="o">=</span><span class="n">BA_name</span><span class="p">,</span>
                    <span class="n">start_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">start_time</span><span class="p">,</span>
                    <span class="n">end_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">end_time</span><span class="p">,</span>
                    <span class="n">split_time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">split_time</span><span class="p">,</span>
                    <span class="n">out_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">out_dir</span><span class="p">,</span>
                    <span class="n">data_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data_dir</span><span class="p">,</span>
                    <span class="n">generate_plots</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">generate_plots</span><span class="p">,</span>
                    <span class="n">plot_gt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_gt</span>
                <span class="p">)</span>

                <span class="n">ba_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BA_name</span><span class="p">),</span> <span class="n">r2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ba</span><span class="o">.</span><span class="n">R2</span><span class="p">),</span> <span class="n">mape</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ba</span><span class="o">.</span><span class="n">MAPE</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">continue</span>

        <span class="c1"># write to file</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;BA&quot;</span><span class="p">:</span> <span class="n">ba_out</span><span class="p">,</span> <span class="s2">&quot;R2&quot;</span><span class="p">:</span> <span class="n">r2</span><span class="p">,</span> <span class="s2">&quot;MAPE&quot;</span><span class="p">:</span> <span class="n">mape</span><span class="p">}</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>

        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_summary_file</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div></div>


<div class="viewcode-block" id="single_ba"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.single_ba">[docs]</a><span class="k">def</span> <span class="nf">single_ba</span><span class="p">(</span>
        <span class="n">data_dir</span><span class="p">,</span>
        <span class="n">out_dir</span><span class="p">,</span>
        <span class="n">ba</span><span class="o">=</span><span class="s1">&#39;PJM&#39;</span><span class="p">,</span>
        <span class="n">start_time</span><span class="o">=</span><span class="s2">&quot;2016-01-01 00:00:00&quot;</span><span class="p">,</span>
        <span class="n">end_time</span><span class="o">=</span><span class="s2">&quot;2018-07-14 23:00:00&quot;</span><span class="p">,</span>
        <span class="n">split_time</span><span class="o">=</span><span class="s2">&quot;2018-06-30 23:00:00&quot;</span><span class="p">,</span>
        <span class="n">plot_gt</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience wrapper for the Analysis class which runs predictive models for a single BA input CSV in the input</span>
<span class="sd">    calls on the analysis function to train and infer on single BA</span>
<span class="sd">    useful for troubleshooting</span>

<span class="sd">    :param data_dir:                Full path to the directory containing the target</span>
<span class="sd">                                    CSV files</span>
<span class="sd">    :param out_dir:                 Full path to the directory where the outputs are to be written</span>

<span class="sd">    :param ba:                      str indicating the balancing authority. default: PJM</span>
<span class="sd">    :param start_time:              str indicating the start-time for analysis. Format YYYY-MM-DD HH:MM:SS.</span>
<span class="sd">                                    Default: 2016-01-01 00:00:00</span>
<span class="sd">    :param end_time:                str indicating the end time for analysis. Default: 2019-12-31 23:00:00</span>
<span class="sd">    :param split_time:              str indicating the timestamp splitting train and test data.</span>
<span class="sd">                                    Default: 2018-12-31 23:00:00</span>

<span class="sd">    :param batch_run:               Indicating if we want to run the simulations for all BAs, or we handpick the BAs</span>
<span class="sd">                                    If batch_run = True, the code will search for all BAs in &#39;dir&#39;</span>
<span class="sd">                                    If batch_run = False, we need to specify which BA to run</span>
<span class="sd">    :type batch_run:                bool</span>

<span class="sd">    :param target_ba_list:          A list of BA names to run if `batch_run` is False</span>
<span class="sd">    :type target_ba_list:           list</span>


<span class="sd">    :param generate_plots:          Choice to generate and save plots</span>
<span class="sd">    :type generate_plots:           bool</span>

<span class="sd">    :param plot_gt:                 Choice to plot ground truth with MLP predictions</span>
<span class="sd">    :type plot_gt:                 bool</span>

<span class="sd">    :return:                        Data frame of BA, R2, MAPE statistics</span>
<span class="sd">h</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">analysis</span> <span class="o">=</span> <span class="n">Analysis</span><span class="p">(</span>
        <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span>
        <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span>
        <span class="n">region</span><span class="o">=</span><span class="n">ba</span><span class="p">,</span>
        <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
        <span class="n">split_time</span><span class="o">=</span><span class="n">split_time</span><span class="p">,</span>
        <span class="n">end_time</span><span class="o">=</span><span class="n">end_time</span><span class="p">,</span>
        <span class="n">plot_gt</span><span class="o">=</span><span class="n">plot_gt</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="predict"><a class="viewcode-back" href="../../tell.html#tell.mlp_predict.predict">[docs]</a><span class="k">def</span> <span class="nf">predict</span><span class="p">(</span>
        <span class="n">data_dir</span><span class="p">,</span>
        <span class="n">out_dir</span><span class="p">,</span>
        <span class="n">start_time</span><span class="o">=</span><span class="s2">&quot;2016-01-01 00:00:00&quot;</span><span class="p">,</span>
        <span class="n">end_time</span><span class="o">=</span><span class="s2">&quot;2019-12-31 23:00:00&quot;</span><span class="p">,</span>
        <span class="n">split_time</span><span class="o">=</span><span class="s2">&quot;2018-12-31 23:00:00&quot;</span><span class="p">,</span>
        <span class="n">batch_run</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">target_ba_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">generate_plots</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convenience wrapper for the Process class which runs predictive models for each BA input CSV in the input</span>
<span class="sd">    directory and creates a summary and comparative figures of R2 and MAPE per BA.</span>

<span class="sd">    :param data_dir:                Full path to the directory containing the target</span>
<span class="sd">                                    CSV files</span>
<span class="sd">    :type data_dir:                 str</span>

<span class="sd">    :param out_dir:                 Full path to the directory where the outputs are to be written</span>

<span class="sd">    :param start_time:              str indicating the start-time for analysis. Format YYYY-MM-DD HH:MM:SS.</span>
<span class="sd">                                    Default: 2016-01-01 00:00:00</span>
<span class="sd">    :param end_time:                str indicating the end time for analysis. Default: 2019-12-31 23:00:00</span>
<span class="sd">    :param split_time:              str indicating the timestamp splitting train and test data.</span>
<span class="sd">                                    Default: 2018-12-31 23:00:00</span>

<span class="sd">    :param batch_run:               Indicating if we want to run the simulations for all BAs, or we handpick the BAs</span>
<span class="sd">                                    If batch_run = True, the code will search for all BAs in &#39;dir&#39;</span>
<span class="sd">                                    If batch_run = False, we need to specify which BA to run</span>
<span class="sd">    :type batch_run:                bool</span>

<span class="sd">    :param target_ba_list:          A list of BA names to run if `batch_run` is False</span>
<span class="sd">    :type target_ba_list:           list</span>


<span class="sd">    :param generate_plots:          Choice to generate and save plots</span>
<span class="sd">    :type generate_plots:           bool</span>

<span class="sd">    :param plot_gt:                 Choice on whether to plot ground truth with MLP predictions</span>
<span class="sd">    :type plot_gt:                  bool</span>

<span class="sd">    :return:                        Data frame of BA, R2, MAPE statistics</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="n">Process</span><span class="p">(</span>
        <span class="n">start_time</span><span class="o">=</span><span class="n">start_time</span><span class="p">,</span>
        <span class="n">end_time</span><span class="o">=</span><span class="n">end_time</span><span class="p">,</span>
        <span class="n">split_time</span><span class="o">=</span><span class="n">split_time</span><span class="p">,</span>
        <span class="n">batch_run</span><span class="o">=</span><span class="n">batch_run</span><span class="p">,</span>
        <span class="n">data_dir</span><span class="o">=</span><span class="n">data_dir</span><span class="p">,</span>
        <span class="n">out_dir</span><span class="o">=</span><span class="n">out_dir</span><span class="p">,</span>
        <span class="n">target_ba_list</span><span class="o">=</span><span class="n">target_ba_list</span><span class="p">,</span>
        <span class="n">generate_plots</span><span class="o">=</span><span class="n">generate_plots</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">proc</span><span class="o">.</span><span class="n">summary_df</span></div>


<span class="c1"># if __name__ == &quot;__main__&quot;:</span>
<span class="c1">#     single_ba(</span>
<span class="c1">#         data_dir=&#39;../data/csv/&#39;,</span>
<span class="c1">#         out_dir=&#39;../python_scripts/outputs&#39;,</span>
<span class="c1">#         ba=&#39;SOCO&#39;,</span>
<span class="c1">#         start_time=&quot;2016-01-01 00:00:00&quot;,</span>
<span class="c1">#         end_time=&quot;2019-12-31 23:00:00&quot;,</span>
<span class="c1">#         split_time=&quot;2018-12-31 23:00:00&quot;,</span>
<span class="c1">#         plot_gt=True</span>
<span class="c1">#     )</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Batelle Memorial Institute.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>